<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

	<!-- Basic Page Needs
  ================================================== -->
  <title>Testing client side javascript</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="author" content="Will Price" />
  <link href="http://feeds.feedburner.com/willpriceblog" type="application/atom+xml" title="Will Price" rel="alternative"/>
	<meta name="description" content="">
	<meta name="author" content="">

	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
  ================================================== -->
	<link rel="stylesheet" href="/css/base.css">
	<link rel="stylesheet" href="/css/skeleton.css">
  <link rel="stylesheet" href="/css/layout.css">
	<link rel="stylesheet" href="/css/user.css">
	<link rel="stylesheet" href="/css/pygments.css">
  <link href='http://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>

  <! -- SCRIPTS
  ================================================== -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script type="text/javascript" src="/scripts/toc.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-41410283-1', 'willprice.org');
    ga('send', 'pageview');
  </script>
  


	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Favicons
	================================================== -->
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

</head>
<body>



	<!-- Primary Page Layout
	================================================== -->

	<!-- Delete everything in this .container and get started on your own site! -->

	<div class="container">
		<div class="sixteen columns">
      <div class="title">
        <a href="/">Will Price</a>
        <a class="extra" href="/posts.html">Posts</a>
        <a class="extra" href="/about.html">About</a>
        <hr />
      </div>

      <section>
      <div class="content">
    <div id="post">
        <h1>Testing client side javascript</h1>
        
        <p>I&#39;ve recently had to look at writing some client-side javascript for an
application I&#39;m developing. Since I love testing, I had to have a look at what
testing framework I should use. Javascript is not Java, there are lots and lots
of testing frameworks. After browsing the most popular projects I decided on
using <a href="http://visionmedia.github.io/mocha/">Mocha</a> to handle test running and
suite generation with <a href="http://chaijs.com">Chai</a> which is used to provide a rich
library of assertions.</p>

<p>These tools can be run on the browser and manipulate the DOM to show outputs. I
personally think this method is quite ugly and slow so I looked into running
things headlessly. A few immediate choices came to mind:</p>

<ul>
<li><a href="http://nodejs.org/">Node.js</a></li>
<li><a href="http://phantomjs.org/">PhantomJS</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Rhino">Rhino</a></li>
</ul>

<p>These projects all run javascript off the browser and hence some don&#39;t support
DOM manipulation (e.g. Rhino).</p>

<p>PhantomJS supports DOM manipulation which is quite a nice feature
if you are eventually going to run your javascript client-side.</p>

<p>Having recently used node for a university project, I thought I&#39;d try something
else that isn&#39;t built on an asynchronous model since I found this made testing
quite difficult. In the end I chose PhantomJS as I running Rhino regularly
sounded quite unpleasant given the time it takes the JVM to start.</p>

<p>Mocha is well supported under PhantomJS and already has a <a href="https://github.com/metaskills/mocha-phantomjs">runner
availabe</a>. I&#39;ll give a few
examples of how to get all these libraries cooperating.</p>

<p>First up you&#39;ll need <code>node</code> installed to give you access to the <code>npm</code> package
manager. It seems like most js projects have adopted it as a package manager
irrespective of whether they target Node.js or the browser.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ sudo npm install -g mocha-phantomjs phantomjs
</code></pre></div>
<p>will pull in PhantomJS, Mocha and the PhantomJS Mocha runner that we&#39;ll use to
run our tests in the command line.</p>

<p>Start a new project somewhere and add a source and tests directory.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ mkdir tests src
</code></pre></div>
<p>Since we&#39;re PhantomJS we need an HTML page that will be run in the headless
browser, this is mainly just a shell that will include all the javascript code
that we wish to run. The advantage of using a platform like Node.js or Rhino
means you can skip this extra step, but then you also lose the ability to
perform DOM manipulation.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ touch tests.html
</code></pre></div>
<p>This file will be used to included all your test suites, this might get pretty
ugly/slow if you&#39;ve got many and large test suites, but you can always break
them up, or you could use python and jinja2 to dynamically create HTML pages
based on the js files you have in your tests directory (I&#39;m sure you could do
this in js as well, but I&#39;m not really familiar with the ecosystem).</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ cat &gt; tests.HTML &lt;&lt; EOF
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;../node_modules/mocha/mocha.css&quot; /&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;mocha&quot;&gt;&lt;/div&gt;
    &lt;script src=&quot;../node_modules/mocha/mocha.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;../node_modules/chai/chai.js&quot;&gt;&lt;/script&gt;
    &lt;script&gt;
      mocha.ui(&#39;tdd&#39;);
      mocha.reporter(&#39;html&#39;);
      assert = chai.assert;
    &lt;/script&gt;
    &lt;script src=&quot;src/fibonacci.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;tests/fibonacci&quot;&gt;&lt;/script&gt;
    &lt;script&gt;
      if (window.mochaPhantomJS) { mochaPhantomJS.run(); }
      else { mocha.run(); }
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
EOF    
</code></pre></div>
<p>This is just a simple document that will include the necessary libraries, setup
Mocha appropriately:</p>

<ul>
<li>Import Mocha and Chai</li>
<li>Use the TDD interface instead of BDD</li>
<li>Use the reporter &#39;html&#39;, this allows us to run open the page with a
browser and check out the results in there too. We&#39;ll specify a different
reporter on the command line when developing code and running tests. </li>
<li>Alias <code>chai.assert</code> as <code>assert</code> for nicer looking test code</li>
<li>Finally check whether the tests are being executed in PhantomJS and use the
mochaPhantomJS runner if they are, otherwise execute Mocha directly.</li>
</ul>

<p>Evidently this HTML has some dependencies that need to be installed before the
code can be run.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ npm install --save mocha chai
</code></pre></div>
<p>will install the necessary testing libraries and the <code>--save</code> flag will produce
a package.json file that can be distributed with your project for other users to
automate downloading dependencies.</p>

<p>The HTML sources <code>tests/test_file.js</code> which needs to be created, this is simply
an example test file:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ cat &gt; tests/fibonacci.js &lt;&lt; EOF
suite(&#39;Recursive fibonacci tests&#39;, function() {
    test(&#39;fib(0) = 0&#39;, function() {
        assert.equal(0, fib(0));
    });
    test(&#39;fib(2) = 1&#39;, function() {
        assert.equal(1, fib(1));
    });
});
EOF

$ cat &gt; src/fibonacci.js &lt;&lt; EOF
function fib(n) {
    if (n &lt; 2) { return n; }
    return fib(n - 1) + fib(n - 2);
}
EOF
</code></pre></div>
<p>Now everything is set up you can run your tests:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ mocha-phantomjs tests.html
</code></pre></div>
<p>Quite nice really. Look into Sinon.js for a nice mocking framework</p>

    </div>
</div>

      </section>
    </div>
    <script type="text/javascript">
      $(document).ready(function() {
        $('.toc').toc();
      });
    </script>
  </div>
  <!-- container -->


<!-- End Document
================================================== -->
</body>
</html>
